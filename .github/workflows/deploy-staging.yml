name: Deploy to Staging

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    name: Build and Deploy to Staging via SSH
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, bcmath

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Run backend tests
      run: |
        composer install --no-interaction --no-dev --optimize-autoloader
        vendor/bin/phpunit || true

    - name: Build frontend
      working-directory: ./frontend
      run: |
        npm ci
        npm run build

    - name: Deploy to remote (SSH)
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.DEPLOY_PORT }}
        script: |
          set -e
          echo "Deploy started on $(hostname)"
          cd ${{ secrets.DEPLOY_PATH }} || exit 1
          git fetch --all
          git reset --hard origin/master
          composer install --no-dev --no-interaction --optimize-autoloader
          php artisan migrate --force || true
          php artisan config:cache || true
          php artisan optimize || true
          # If frontend should be built on remote instead of CI, uncomment:
          # cd frontend && npm ci && npm run build
          # Restart services (adjust for your stack)
          if command -v systemctl >/dev/null 2>&1; then
            sudo systemctl restart php8.2-fpm || true
            sudo systemctl restart nginx || true
          else
            echo "Systemd not found; restart webserver manually if needed"
          fi

    - name: Notify
      run: echo "Deploy finished"

  